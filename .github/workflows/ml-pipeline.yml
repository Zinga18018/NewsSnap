name: ML Pipeline — Build & Train

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "Dockerfile"
      - "requirements.txt"
  workflow_dispatch:
    inputs:
      force_training:
        description: "Force training even without code changes"
        required: false
        default: "false"
        type: boolean

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: us-east-1

jobs:
  build-and-push:
    name: Build Docker → ECR
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.build.outputs.image_uri }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Docker image
        id: build
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY: llmops-training
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  trigger-training:
    name: Trigger SageMaker Training
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install boto3 sagemaker python-dotenv

      - name: Trigger SageMaker Training Job
        env:
          IMAGE_URI: ${{ needs.build-and-push.outputs.image_uri }}
          SAGEMAKER_ROLE_ARN: ${{ secrets.SAGEMAKER_ROLE_ARN }}
        run: |
          python -c "
          import boto3
          import os
          from datetime import datetime

          sm = boto3.client('sagemaker', region_name='us-east-1')

          job_name = f'llmops-training-{datetime.now().strftime(\"%Y%m%d-%H%M%S\")}'

          sm.create_training_job(
              TrainingJobName=job_name,
              RoleArn=os.environ['SAGEMAKER_ROLE_ARN'],
              AlgorithmSpecification={
                  'TrainingImage': os.environ['IMAGE_URI'],
                  'TrainingInputMode': 'File',
              },
              InputDataConfig=[{
                  'ChannelName': 'training',
                  'DataSource': {
                      'S3DataSource': {
                          'S3DataType': 'S3Prefix',
                          'S3Uri': 's3://llmops-ml-data-dev/processed/',
                          'S3DataDistributionType': 'FullyReplicated',
                      }
                  },
                  'ContentType': 'application/json',
              }],
              OutputDataConfig={'S3OutputPath': 's3://llmops-ml-models-dev/training-output/'},
              ResourceConfig={
                  'InstanceType': 'ml.m5.large',
                  'InstanceCount': 1,
                  'VolumeSizeInGB': 30,
              },
              StoppingCondition={'MaxRuntimeInSeconds': 7200},
              HyperParameters={
                  'model_name': 'distilbert-base-uncased',
                  'num_labels': '4',
                  'epochs': '3',
                  'batch_size': '32',
                  'learning_rate': '2e-5',
              },
          )
          print(f'Training job created: {job_name}')
          "
